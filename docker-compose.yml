services:
  # ---------------------------------------------------------------------------
  # Docker Compose for ARCS
  # Amateur Radio Call Search
  # ---------------------------------------------------------------------------

  # ---------------------------------------------------------------------------
  # MariaDB (persistent database)
  # ---------------------------------------------------------------------------
  uls-mariadb:
    image: mariadb:11
    container_name: arcs-uls-mariadb
    user: "0:0"

    environment:
      MARIADB_DATABASE: uls
      MARIADB_USER: uls
      MARIADB_PASSWORD_FILE: /run/secrets/mariadb_user_password
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/mariadb_root_password
      TZ: America/Chicago

    secrets:
      - mariadb_root_password
      - mariadb_user_password
      - callbook_ro_password

    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --local-infile=1
      - --innodb_flush_log_at_trx_commit=2
      - --sync_binlog=0
      - --skip-name-resolve

    volumes:
      - uls_db_data:/var/lib/mysql

    networks:
      - uls_db_net

    healthcheck:
      test:
        - CMD-SHELL
        - mariadb-admin ping -h 127.0.0.1 -uroot -p"$(cat /run/secrets/mariadb_root_password)" --silent
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s

    restart: unless-stopped


  # ---------------------------------------------------------------------------
  # Importer (one-shot job container)
  # ---------------------------------------------------------------------------
  uls-importer:
    build: ./importer
    container_name: arcs-uls-importer

    depends_on:
      uls-mariadb:
        condition: service_healthy

    environment:
      DB_HOST: uls-mariadb
      DB_NAME: uls
      DB_USER: uls
      DB_PASS_FILE: /run/secrets/mariadb_user_password
      DATA_DIR: /data
      TZ: America/Chicago

    secrets:
      - mariadb_user_password

    volumes:
      - uls_cache:/data
      - ./importer/schema.sql:/app/schema.sql:ro
      - ./importer/import_uls.py:/app/import_uls.py:ro

    networks:
      - uls_db_net
      - uls_ext_net

    restart: "no"


  # ---------------------------------------------------------------------------
  # XML API (public query service)
  # ---------------------------------------------------------------------------
  xml-api:
    build: ./xml-api
    container_name: arcs-xml-api

    depends_on:
      uls-mariadb:
        condition: service_healthy

    environment:
      DB_HOST: uls-mariadb
      DB_NAME: uls
      DB_USER: uls
      DB_PASS_FILE: /run/secrets/mariadb_user_password

      # Optional: API version shown in /health
      ARCS_API_VERSION: "0.1.0"

      # Optional: CORS origin for browser-based debugging; we'll tighten in the next step.
      # CORS_ALLOW_ORIGIN: "http://192.168.1.121:8081"

    secrets:
      - mariadb_user_password

    networks:
      - uls_db_net
      - uls_ext_net

    ports:
      - "8080:8000"

    restart: unless-stopped

    volumes:
      - ./xml-api/app.py:/app/app.py:ro


  # ---------------------------------------------------------------------------
  # Web UI (static + reverse-proxy /api -> xml-api)
  # ---------------------------------------------------------------------------
  web-ui:
    build: ./web-ui
    container_name: arcs-web-ui

    environment:
      # UI will default to same-origin "/api" via nginx proxy
      UI_API_BASE_URL: "/api"

    ports:
      - "8081:80"

    depends_on:
      - xml-api

    networks:
      - uls_ext_net

    restart: unless-stopped


  # ---------------------------------------------------------------------------
  # Smoke Test (one-shot startup verification)
  #
  # Purpose:
  #   Validate the stack is healthy *at startup time* without enabling
  #   continuous Docker healthchecks (which run forever).
  #
  # Usage:
  #   docker compose up -d --build
  #   docker compose run --rm arcs-smoketest
  #
  # Future:
  #   If you want continuous monitoring, enable the healthcheck blocks on
  #   xml-api / web-ui instead of (or in addition to) this.
  # ---------------------------------------------------------------------------
  arcs-smoketest:
    image: alpine:3.20
    container_name: arcs-smoketest
    depends_on:
      - xml-api
      - web-ui
    networks:
      - uls_ext_net
    entrypoint: ["/bin/sh", "-lc"]
    command: >
      apk add --no-cache curl >/dev/null &&
      echo "[ARCS] Waiting for xml-api..." &&
      for i in $(seq 1 30); do
        curl -fsS http://xml-api:8000/health >/dev/null 2>&1 && break
        sleep 5
      done &&
      echo "[ARCS] xml-api health OK" &&
      echo "[ARCS] Smoke test complete."
    restart: "no"


# ---------------------------------------------------------------------------
# Networks
# ---------------------------------------------------------------------------
networks:
  uls_db_net:
    name: uls_db_net
    driver: bridge
    internal: true

  uls_ext_net:
    name: uls_ext_net
    driver: bridge


# ---------------------------------------------------------------------------
# Volumes
# ---------------------------------------------------------------------------
volumes:
  uls_db_data:
  uls_cache:


# ---------------------------------------------------------------------------
# Secrets
# ---------------------------------------------------------------------------
secrets:
  mariadb_root_password:
    file: ./secrets/mariadb_root_password.txt

  mariadb_user_password:
    file: ./secrets/mariadb_user_password.txt

  callbook_ro_password:
    file: ./secrets/callbook_ro_password.txt
