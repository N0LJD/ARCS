services:
  # ---------------------------------------------------------------------------
  # Docker Compose for ARCS (Amateur Radio Call Search)
  # Edward Moss - N0LJD
  # ---------------------------------------------------------------------------

  # ---------------------------------------------------------------------------
  # MariaDB (persistent database)
  # ---------------------------------------------------------------------------
  uls-mariadb:
    image: mariadb:11
    environment:
      MARIADB_DATABASE: uls
      MARIADB_USER: uls
      MARIADB_PASSWORD_FILE: /run/secrets/mariadb_user_password
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/mariadb_root_password
      TZ: America/Chicago

    secrets:
      - mariadb_root_password
      - mariadb_user_password

    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --local-infile=1
      - --innodb_flush_log_at_trx_commit=2
      - --sync_binlog=0
      - --skip-name-resolve

    volumes:
      - uls_db_data:/var/lib/mysql
      - ./db-init:/docker-entrypoint-initdb.d:ro

    networks:
      - uls_db_net

    healthcheck:
      test:
        - CMD-SHELL
        - mariadb-admin ping -h 127.0.0.1 -uroot -p"$(cat /run/secrets/mariadb_root_password)" --silent
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s

    restart: unless-stopped


  # ---------------------------------------------------------------------------
  # Importer (one-shot job container)
  # ---------------------------------------------------------------------------
  uls-importer:
    build: ./importer
    depends_on:
      uls-mariadb:
        condition: service_healthy

    environment:
      DB_HOST: uls-mariadb
      DB_NAME: uls
      DB_USER: uls
      DB_PASS_FILE: /run/secrets/mariadb_user_password
      DATA_DIR: /data
      TZ: America/Chicago

    secrets:
      - mariadb_user_password

    volumes:
      - uls_cache:/data
      - ./importer/schema.sql:/app/schema.sql:ro
      - ./importer/import_uls.py:/app/import_uls.py:ro

    networks:
      - uls_db_net
      - uls_ext_net

    restart: "no"


  # ---------------------------------------------------------------------------
  # XML API (public query service)
  # ---------------------------------------------------------------------------
  xml-api:
    build: ./xml-api
    depends_on:
      uls-mariadb:
        condition: service_healthy

    environment:
      DB_HOST: uls-mariadb
      DB_NAME: uls
      DB_USER: callbook_ro
      DB_PASS_FILE: /run/secrets/callbook_ro_password
      TZ: America/Chicago

    secrets:
      - callbook_ro_password

    networks:
      - uls_db_net
      - uls_ext_net

    ports:
      - "8080:8000"

    restart: unless-stopped

    volumes:
      - ./xml-api/app.py:/app/app.py:ro


  # ---------------------------------------------------------------------------
  # Web UI (nginx static UI + reverse proxy to xml-api)
  # ---------------------------------------------------------------------------
  web-ui:
    build: ./web-ui
    environment:
      # Prefer same-origin proxying via /api in nginx.
      - UI_API_BASE_URL=/api
    ports:
      - "8081:80"
    depends_on:
      - xml-api

    networks:
      - uls_ext_net


# ---------------------------------------------------------------------------
# Networks
# ---------------------------------------------------------------------------
networks:
  uls_db_net:
    name: uls_db_net
    driver: bridge
    internal: true

  uls_ext_net:
    name: uls_ext_net
    driver: bridge


# ---------------------------------------------------------------------------
# Volumes
# ---------------------------------------------------------------------------
volumes:
  uls_db_data:
  uls_cache:


# ---------------------------------------------------------------------------
# Secrets
# ---------------------------------------------------------------------------
secrets:
  mariadb_root_password:
    file: ./secrets/mariadb_root_password.txt

  mariadb_user_password:
    file: ./secrets/mariadb_user_password.txt

  callbook_ro_password:
    file: ./secrets/callbook_ro_password.txt
