services:
  # ---------------------------------------------------------------------------
  # Docker Compose for ARCS
  # Amateur Radio Call Service
  # ---------------------------------------------------------------------------
  #
  # NOTE ON STARTUP ORDER (IMPORTANT):
  # - The importer needs a write-capable DB user ("uls") to apply schema and load data.
  # - The public XML API should use a read-only DB user ("xml_api") for least privilege.
  #
  # Because "xml_api" is created/granted AFTER the database is initialized/imported,
  # a fully automatic "docker compose up -d" can race: xml-api may start before the
  # read-only user exists.
  #
  # For now, admin/arcsctl.sh handles the safe sequence:
  #   1) Start MariaDB
  #   2) Run importer
  #   3) Create/grant xml_api (read-only)
  #   4) Start xml-api + web-ui
  #
  # FUTURE (optional):
  # - Add an xml-api "wait wrapper" entrypoint that waits for db auth to succeed,
  #   enabling single-command bring-up without sequencing.
  # ---------------------------------------------------------------------------

  # ---------------------------------------------------------------------------
  # MariaDB (persistent database)
  # ---------------------------------------------------------------------------
  uls-mariadb:
    image: mariadb:11
    container_name: arcs-uls-mariadb

    environment:
      MARIADB_DATABASE: uls
      MARIADB_USER: uls
      MARIADB_PASSWORD_FILE: /run/secrets/mariadb_user_password
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/mariadb_root_password
      TZ: America/Chicago

    secrets:
      - mariadb_root_password
      - mariadb_user_password

    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --local-infile=1
      - --innodb_flush_log_at_trx_commit=2
      - --sync_binlog=0
      - --skip-name-resolve

    volumes:
      - uls_db_data:/var/lib/mysql
      - ./db-init:/docker-entrypoint-initdb.d:ro

    networks:
      - uls_db_net

    # Healthcheck runs continuously. If you later prefer "only at startup",
    # you can disable it and use a one-shot wait script instead.
    healthcheck:
      test:
        - CMD-SHELL
        - mariadb-admin ping -h 127.0.0.1 -uroot -p"$(cat /run/secrets/mariadb_root_password)" --silent
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s

    restart: unless-stopped


  # ---------------------------------------------------------------------------
  # Importer (one-shot job container)
  # - Uses the write-capable "uls" DB account.
  # - Writes canonical importer metadata to /logs/arcs-state.json
  #   (bind-mounted from host ./logs).
  # ---------------------------------------------------------------------------
  uls-importer:
    image: ghcr.io/n0ljd/arcs-uls-importer:v1.0.0-baseline
    container_name: arcs-uls-importer

    depends_on:
      uls-mariadb:
        condition: service_healthy

    environment:
      DB_HOST: uls-mariadb
      DB_NAME: uls
      DB_USER: uls
      DB_PASS_FILE: /run/secrets/mariadb_user_password
      DATA_DIR: /data
      TZ: America/Chicago

      # Canonical ARCS state file (inside container). Host binds ./logs -> /logs.
      ARCS_STATE_PATH: /logs/arcs-state.json

    secrets:
      - mariadb_user_password

    volumes:
      - uls_cache:/data
      - ./importer/schema.sql:/app/schema.sql:ro
      - ./importer/import_uls.py:/app/import_uls.py:ro

      # Canonical state + operational artifacts
      - ./logs:/logs

    networks:
      - uls_db_net
      - uls_ext_net

    restart: "no"


  # ---------------------------------------------------------------------------
  # XML API (public query service)
  # - Uses read-only DB user: "xml_api"
  # - Password is provided via docker secret "xml_api_password"
  # ---------------------------------------------------------------------------
  xml-api:
    image: ghcr.io/n0ljd/arcs-xml-api:v1.0.0-baseline
    container_name: arcs-xml-api

    depends_on:
      uls-mariadb:
        condition: service_healthy

    environment:
      DB_HOST: uls-mariadb
      DB_NAME: uls
      DB_USER: xml_api
      DB_PASS_FILE: /run/secrets/xml_api_password
      TZ: America/Chicago

      # Optional: API version shown in /health
      ARCS_API_VERSION: "1.0.0"

      # Optional: tighten CORS for browser debugging; keep unset for server-to-server usage.
      # CORS_ALLOW_ORIGIN: "http://127.0.0.1:8081"

    secrets:
      - xml_api_password

    networks:
      - uls_db_net
      - uls_ext_net

    ports:
      - "8080:8000"

    restart: unless-stopped

    volumes:
      - ./xml-api/app.py:/app/app.py:ro


  # ---------------------------------------------------------------------------
  # Web UI (static + reverse-proxy /api -> xml-api)
  # ---------------------------------------------------------------------------
  web-ui:
    image: ghcr.io/n0ljd/arcs-web-ui:v1.0.0-baseline
    container_name: arcs-web-ui

    environment:
      # UI will default to same-origin "/api" via nginx proxy
      UI_API_BASE_URL: "/api"
      ARCS_UI_VERSION: ${ARCS_UI_VERSION:-dev}

    ports:
      - "8081:80"

    depends_on:
      - xml-api

    networks:
      - uls_ext_net

    restart: unless-stopped


# ---------------------------------------------------------------------------
# Networks
# ---------------------------------------------------------------------------
networks:
  uls_db_net:
    name: uls_db_net
    driver: bridge
    internal: true

  uls_ext_net:
    name: uls_ext_net
    driver: bridge


# ---------------------------------------------------------------------------
# Volumes
# ---------------------------------------------------------------------------
volumes:
  uls_db_data:
  uls_cache:


# ---------------------------------------------------------------------------
# Secrets
# ---------------------------------------------------------------------------
secrets:
  mariadb_root_password:
    file: ./secrets/mariadb_root_password.txt

  mariadb_user_password:
    file: ./secrets/mariadb_user_password.txt

  # Password used by the read-only MariaDB user "xml_api" (used by the xml-api service)
  xml_api_password:
    file: ./secrets/xml_api_password.txt
